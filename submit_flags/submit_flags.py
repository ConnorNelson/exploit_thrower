#!/usr/bin/env python

import sys
import logging
import socket
import re

import redis


logging.basicConfig(format='%(message)s', stream=sys.stdout, level=logging.INFO)
l = logging.getLogger('submit_flags')


def main():
    r = redis.Redis(host='redis', port=6379)
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('submission.ctf.saarland', 31337))

    while True:
        _, flag = r.blpop('flags.pending')

        try:
            s.send(flag + b'\n')
            response = s.recv(4096).strip()
            l.info('[submit flag] %s: %s', flag, response)

            group = re.sub('[^\w]', '', response.decode().replace(' ', '_'))
            r.sadd(f'flags.{group}', flag)

        except Exception as e:
            r.lpush('flags.pending', target)
            l.exception(e)


if __name__ == '__main__':
    main()
